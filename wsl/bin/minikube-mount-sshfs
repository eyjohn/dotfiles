#!/bin/bash

BASE="$1"
if [ -n "$2" ]; then
  MOUNT="$2"
else
  MOUNT="$BASE"
fi

# Generate, authorise, upload ssh keys and make target dir
rm ~/.ssh/minikube*
ssh-keygen -f ~/.ssh/minikube -N "" -C "minikube-sshfs"
sed -i '/minikube-sshfs$/d' ~/.ssh/authorized_keys
cat .ssh/minikube.pub >> ~/.ssh/authorized_keys
scp -p ~/.ssh/minikube minikube:~/.ssh/
ssh minikube sudo mkdir -p -m 777 "$MOUNT"
ssh minikube fusermount -u "$MOUNT"

# Connect in foreground mode
ssh -R 20202:localhost:22 minikube sshfs -f -d -o NoHostAuthenticationForLocalhost=yes -o IdentityFile='~/.ssh/minikube' -o port=20202 -o nonempty $USER@localhost:"$BASE/" "$MOUNT"
